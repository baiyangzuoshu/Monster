{"version":3,"sources":["assets\\Scripts\\ECS\\ECSManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/life-cycle-callbacks.html\n\nimport ECSFactory from \"./ECSFactory\";\nimport BulletEntity from \"./Entities/BulletEntity\";\nimport CannonEntitiy from \"./Entities/CannonEntitiy\";\nimport MonsterEntity from \"./Entities/MonsterEntity\";\nimport AISystem from \"./Systems/AISystem\";\nimport AnimateSystem from \"./Systems/AnimateSystem\";\nimport AttackSystem from \"./Systems/AttackSystem\";\nimport CollectHitSystem from \"./Systems/CollectHitSystem\";\nimport NavSystem from \"./Systems/NavSystem\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class ECSManager extends cc.Component {\n\n    private static _instance:ECSManager=null\n    public static getInstance():ECSManager{\n        return ECSManager._instance\n    }\n\n    onLoad () {\n        if(null===ECSManager._instance){\n            ECSManager._instance=this\n        }\n        else{\n            this.destroy()\n            return\n        }\n    }\n\n    private monsters:Array<MonsterEntity>=[];\n    private cannones:Array<CannonEntitiy>=[];\n    private bullets:Array<BulletEntity>=[];\n\n    async createMonsterEntity(type,index,list,hp,gold,speed){\n        let entity=await ECSFactory.getInstance().createMonsterEntity(type,index,list,hp,gold,speed);\n        this.monsters.push(entity);\n\n        return entity\n    }\n\n    public async createCannonEntity(index:number,level:number){\n        let entity=await ECSFactory.getInstance().createCannonEntity(index,level);\n        this.cannones.push(entity);\n\n        return entity\n    }\n\n    public async createBulletEntity(level:number,worldPos:cc.Vec3,attackTarget:cc.Node,angle:number){\n        let entity=await ECSFactory.getInstance().createBulletEntity(level,worldPos,attackTarget,angle);\n        this.bullets.push(entity);\n\n        return entity\n    }\n\n    navSystemMonster(dt:number){\n        for(let i=0;i<this.monsters.length;i++){\n            NavSystem.getInstance().onUpdate(dt,this.monsters[i].navComponent,this.monsters[i].baseComponent,this.monsters[i].transformComponent);\n        }\n    }\n\n    animateSystemMonster(dt:number){\n        for(let i=0;i<this.monsters.length;i++){\n            AnimateSystem.getInstance().onMonsterUpdate(dt,this.monsters[i].baseComponent,this.monsters[i].roleComponent,this.monsters[i].animateComponent);\n        }\n    }\n\n    animateSystemBullet(dt:number){\n        for(let i=0;i<this.bullets.length;i++){\n            AnimateSystem.getInstance().onBulletUpdate(dt,this.bullets[i].baseComponent,this.bullets[i].animateComponent);\n        }\n    }\n\n    attackSystemUpdate(dt:number){\n        for(let i=0;i<this.cannones.length;i++){\n            AttackSystem.getInstance().onUpdate(dt,this.cannones[i].unitComponent,this.cannones[i].baseComponent,this.cannones[i].roleComponent);\n        }\n    }\n\n    AISystemBullet(dt:number){\n        for(let i=0;i<this.bullets.length;i++){\n            AISystem.getInstance().onBulletUpdate(dt,this.bullets[i].unitComponent,this.bullets[i].baseComponent,this.bullets[i].transformComponent,this.bullets[i].roleComponent,this.bullets[i].animateComponent);\n        }\n    }\n\n    collectHitSystemBullet(dt:number){\n        for(let i=0;i<this.bullets.length;i++){\n            let hitPos=cc.v2(this.bullets[i].unitComponent.m_attackTarget.x,this.bullets[i].unitComponent.m_attackTarget.y);\n            let isHit=CollectHitSystem.getInstance().onUpdate(dt,hitPos,this.bullets[i].shapeComponent,this.bullets[i].transformComponent,this.bullets[i].unitComponent);\n            if(isHit){\n                this.bullets[i].unitComponent.isDead=true;\n                this.bullets[i].baseComponent.gameObject.destroy();\n                this.bullets.splice(i,1);\n                i--;\n            }\n        }\n    }\n\n    calcNearDistance(cannon):MonsterEntity{\n        var minDis = 9999;\n        var minMonster:MonsterEntity = null;\n        var curDis = 230;\n        \n        for (let i = 0; i < this.monsters.length; i++) {\n            let monster=this.monsters[i];\n            if( monster.unitComponent.isDead )continue;\n\n            let src=cc.v2(monster.baseComponent.gameObject.x,monster.baseComponent.gameObject.y);\n            let dst=cc.v2(cannon.x,cannon.y);\n            let dis=src.sub(dst).mag();\n            \n            if(dis < curDis && dis < Math.abs( minDis) ){\n                minDis = dis;\n                minMonster = monster;\n            }\n        }\n        //cc.log(minDis);\n        return minMonster;\n    }\n\n    protected update(dt: number): void {\n        //怪物行走\n        this.navSystemMonster(dt);\n        //怪物动画\n        this.animateSystemMonster(dt);\n        //子弹动画\n        this.animateSystemBullet(dt);\n        //AI\n        this.AISystemBullet(dt);\n        //碰撞检测\n        this.collectHitSystemBullet(dt);\n        //\n        this.attackSystemUpdate(dt);\n    }\n}\n"]}