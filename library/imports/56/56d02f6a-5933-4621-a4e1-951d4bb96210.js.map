{"version":3,"sources":["assets\\Scripts\\ECS\\Systems\\AttackSystem.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// Learn TypeScript:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/typescript.html\n// Learn Attribute:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - https://docs.cocos.com/creator/2.4/manual/en/scripting/life-cycle-callbacks.html\n\nimport { EventManager } from \"../../../FrameWork/manager/EventManager\";\nimport { UIManagerPro } from \"../../../FrameWork/manager/UIManagerPro\";\nimport { util } from \"../../../FrameWork/Utils/util\";\nimport DataManager from \"../../data/DataManager\";\nimport IntensifyDataManager from \"../../data/IntensifyDataManager\";\nimport {Intensify, Task, UnitState } from \"../../Enum\";\nimport { GameUI } from \"../../EventName\";\nimport PlayerDataManager from \"../../Manager/PlayerDataManager\";\nimport AttackComponent from \"../Components/AttackComponent\";\nimport BaseComponent from \"../Components/BaseComponent\";\nimport RoleComponent from \"../Components/RoleComponent\";\nimport UnitComponent from \"../Components/UnitComponent\";\nimport ECSManager from \"../ECSManager\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class AttackSystem extends cc.Component {\n\n    private static _instance:AttackSystem=null\n    public static getInstance():AttackSystem{\n        return AttackSystem._instance\n    }\n\n    onLoad () {\n        if(null===AttackSystem._instance){\n            AttackSystem._instance=this\n        }\n        else{\n            this.destroy()\n            return\n        }\n    }\n\n    public attackStartAction(hp:number,bulletUnitComponent:UnitComponent,monsterUnitComponent:UnitComponent,monsterBaseComponent:BaseComponent,monsterAttackComponent:AttackComponent){\n        if(monsterUnitComponent.isDead ){\n            return;\n        }\n        if( hp == null ){\n            cc.log('攻击力未定义');\n            return;\n        }\n       \n        var rand = util.randomNum(0,1000);\n        var isDouble = false;\n        if( rand <= 500){\n            var lv = PlayerDataManager.getInstance().getInternsifLevel(Intensify.INTENSIFY_BAOJI);\n            var double = IntensifyDataManager.getInstance().getValue(Intensify.INTENSIFY_BAOJI,lv);\n            hp = hp*2+hp*(double/100);\n            hp = hp+hp*(double/100);\n            hp = Math.floor(hp);\n            isDouble = true;\n        }\n        \n        monsterAttackComponent.hp -= hp;\n        if( monsterAttackComponent.hp <= 0 ){\n            monsterBaseComponent.gameObject.stopAllActions();\n            let m_HpBar=monsterBaseComponent.gameObject.getChildByName(\"item\").getChildByName(\"hp\").getChildByName(\"bar\").getComponent(cc.ProgressBar);\n            m_HpBar.progress = 0;\n\n            monsterUnitComponent.isDead = true;\n            monsterBaseComponent.gameObject.opacity = 0;\n\n            bulletUnitComponent.attackEntity = null;\n\n            var pos = monsterBaseComponent.gameObject.getPosition();\n            //g_effectBuild.createDeadEffect(pos);\n            var cale_gold = monsterAttackComponent.gold;\n            \n            if( cale_gold > 0){\n                var flyEnd = function(gold){\n                    PlayerDataManager.getInstance().addGold(gold);\n                    EventManager.getInstance().emit(GameUI.updateGameUI);\n                }\n                //g_coinFly.createCoinToTip(this.node,flyEnd.bind(this),cale_gold);\n            }\n\n            DataManager.getInstance().subCurMonsterCount();\n            //杀死最后一个怪物\n            if( DataManager.getInstance().getCurMonsterCount() <= 0 ){\n                //显示结算框\n                EventManager.getInstance().emit(GameUI.showSucceed);\n                // //2面以后关闭结算框,进行下一局\n                this.scheduleOnce(function() {\n                    UIManagerPro.getInstance().closePrefab(\"SmallSettlementUI\");\n                }, 2);\n            }\n            \n            PlayerDataManager.getInstance().addTaskCount(Task.TASK_JIDAO_DIREN);\n            \n        }else{\n            let m_HpBar=monsterBaseComponent.gameObject.getChildByName(\"item\").getChildByName(\"hp\").getChildByName(\"bar\").getComponent(cc.ProgressBar);\n            m_HpBar.progress = monsterAttackComponent.hp / monsterAttackComponent.maxHp;\n        }\n        let str=\"\";\n        if( isDouble ){\n            str = '暴击'+hp;\n        }\n        //g_hpEffect.createHpEffect(this.node.getPosition(),str);\n        let worldPos=monsterBaseComponent.gameObject.convertToWorldSpaceAR(cc.v3(0,0,0));\n        EventManager.getInstance().emit(GameUI.createHpEffect,{worldPos:worldPos,str:str});\n    }\n\n    async onUpdate(dt,cannonUnitComponent:UnitComponent,cannonBaseComponent:BaseComponent,cannonRoleComponent:RoleComponent,cannonAttackComponent:AttackComponent) {\n        if(cannonUnitComponent.state != UnitState.Active||cannonUnitComponent.isDead){\n            return\n        }\n        \n        if( cannonUnitComponent.attackEntity == null){\n            cannonUnitComponent.attackEntity = ECSManager.getInstance().calcNearDistance(cannonBaseComponent.gameObject);\n        }\n\n        if( cannonUnitComponent.attackEntity != null){\n            if( cannonUnitComponent.isDead ){\n                cannonUnitComponent.attackEntity=null;\n                return;\n            }\n            var end = cannonUnitComponent.attackEntity.baseComponent.gameObject.getPosition();\n\n            let src=cc.v3(end.x,end.y,0)\n            let dst=cc.v3(cannonBaseComponent.gameObject.x,cannonBaseComponent.gameObject.y,0)\n            let dir=cc.v3()\n            cc.Vec3.subtract(dir,src,dst)\n            var dis = dir.len();\n            //cc.log(dis);\n            var curDis = 230;\n            Math.abs(dis);\n            if(dis > curDis ){\n                cannonUnitComponent.attackEntity=null;\n                return;\n            }\n            var start = cannonBaseComponent.gameObject.getPosition();\n            \n            var angle = util.getAngle(start,end);\n            angle += 360;\n            angle -= 90;\n\n            cannonUnitComponent.fireTime-=dt;\n\n            if( cannonUnitComponent.fireTime>0 ){\n                cannonUnitComponent.angle=angle;\n                cannonBaseComponent.gameObject.getChildByName(\"gun\").angle=cannonUnitComponent.angle;\n            }else{\n                var moveAngle = 300*dt;\n                if( cannonUnitComponent.angle > angle || \n                    angle - cannonUnitComponent.angle > 180 ){\n                    moveAngle = -moveAngle;\n                }\n\n                cannonUnitComponent.angle += moveAngle;\n                cannonBaseComponent.gameObject.getChildByName(\"gun\").angle=cannonUnitComponent.angle;\n\n                if( cannonUnitComponent.angle < 0 ) {\n                    cannonUnitComponent.angle += 360;\n                    cannonBaseComponent.gameObject.getChildByName(\"gun\").angle=cannonUnitComponent.angle;\n                }\n\n                if( Math.abs(cannonUnitComponent.angle - angle) < Math.abs(moveAngle) ){\n                    cannonUnitComponent.fireTime = 1.0;\n                    \n                    let worldPos=cannonBaseComponent.gameObject.getChildByName(\"gun\").convertToWorldSpaceAR(cc.v3(0,0,0));\n                    let bulletEntity=await ECSManager.getInstance().createBulletEntity(cannonRoleComponent.level,worldPos,cannonUnitComponent.attackEntity,cannonUnitComponent.angle);\n\n                    cannonBaseComponent.gameObject.getChildByName(\"gun\").angle=angle;\n                    cannonUnitComponent.angle=angle;\n\n                    this.attackStartAction(cannonAttackComponent.atk,bulletEntity.unitComponent,cannonUnitComponent.attackEntity.unitComponent,cannonUnitComponent.attackEntity.baseComponent,cannonUnitComponent.attackEntity.attackComponent);\n                    \n                    cannonUnitComponent.attackEntity = null;\n                }\n            }\n        }\n    }\n}\n"]}